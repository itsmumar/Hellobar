(function() {
  if (typeof(hellobar) === 'undefined') {

    // Load HelloBar JS Core and Modules
    (function() {
      // Loading core for module management
      var hellobar = {{{core_js}}}

      function defineExternalLibrariesAsModules() {
        hellobar.defineModule('lib.crypto', [], function () {
          {{{crypto_js}}}
          return CryptoJS;
        });
      }

      defineExternalLibrariesAsModules();

      // Loading all HelloBar modules
      {{{modules_js}}}

      // A few helper functions
      function hasCapability(capability) {
        return hellobar('base.capabilities').has(capability);
      }

      function isPreviewMode() {
        return hellobar('base.preview').isActive();
      }

      function scriptIsInstalledProperly() {
        return hellobar('base.selfcheck').scriptIsInstalledProperly();
      }

      function configure(moduleName, configurator) {
        hellobar(moduleName, { configurator: configurator });
      }

      // Initialize and configure modules
      configure('base.preview', function(configuration) {
        configuration.previewIsActive({{preview_is_active}});
      });

      configure('base.capabilities', function(configuration) {
        configuration.capabilities({{{capabilities_json}}});
      });

      configure('base.site', function(configuration) {
        configuration.siteId({{site_id}}).siteUrl('{{site_url}}').secret('{{pro_secret}}');
      });

      function initializeProtectedModules() {

        configure('base.timezone', function(configuration) {
          configuration.defaultTimezone('{{site_timezone}}');
        });

        configure('base.styling', function(configuration) {
          configuration.externalCSS({{{hellobar_container_css}}});
        });

        configure('base.templating', function(configuration) {
          {{#templates}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/templates}}

          {{#branding_templates}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/branding_templates}}

          {{#content_upgrade_template}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/content_upgrade_template}}
        });

        configure('geolocation', function(configuration) {
          configuration.geolocationUrl('{{geolocation_url}}');
        });

        !isPreviewMode() && hasCapability('geolocation_injection') && configure('geolocation.injection', function(configuration) {
          configuration.autoRun(true);
        });

        !isPreviewMode() && configure('tracking.internal', function(configuration) {
          configuration.backendHost('{{hb_backend_host}}').siteWriteKey('{{site_write_key}}');
        });

        !isPreviewMode() && hasCapability('external_tracking') && configure('tracking.external', function(configuration) {
          var externalTrackings = {{{external_tracking_json}}};
          configuration.externalTrackings(externalTrackings);
        });

        configure('elements.rules', function(configuration) {
          {{#rules}}
            configuration.addRule('{{match}}', {{{conditions}}}, {{{site_elements}}});
          {{/rules}}
        });

        configure('elements', function(configuration) {
          configuration.elementCSS({{{hellobar_element_css}}}).autoRun(true);
        });

        configure('contentUpgrades', function(configuration) {
          configuration.contentUpgrades({{{content_upgrades_json}}}).styles({{{content_upgrades_styles_json}}});
        });

        !isPreviewMode() && hasCapability('autofills') && configure('autofills', function(configuration) {
          var autofills = {{{autofills_json}}};
          configuration.autofills(autofills).autoRun(true);
        });

        configure('base.metainfo', function(configuration) {
          configuration.version("{{version}}");
          configuration.timestamp("{{timestamp}}");
        });
      }

      if(!hellobar('base.environment').isIEXOrLess(8) && {{script_is_installed_properly}}) {
        initializeProtectedModules();
      }
    })();

  } else {
    console.warn('Hello Bar script is already loaded. It seems like you are including the Hello Bar script more than once. Ignoring.');
  }
})();
