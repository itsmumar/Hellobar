(function() {
  if (typeof(HB) == "undefined") {
    
    // HelloBar JS Modules
    (function() {
      // Loading core for module management
      var hellobar = {{{core_js}}}

      // Loading all modules
      {{{modules_js}}}

      // A few helper functions
      function hasCapability(capability) {
        return hellobar('base.capabilities').has(capability);
      }

      function isPreviewMode() {
        return hasCapability('preview');
      }

      // Configure modules

      hellobar('base.capabilities', {
        configurator: function(configuration) {
          configuration.capabilities({{{capabilities_json}}});
        }
      });

      hellobar('base.site', {
        configurator: function(configuration) {
          configuration.siteId({{site_id}}).siteUrl('{{site_url}}').secret('{{pro_secret}}');
        }
      });

      hellobar('base.timezone', {
        configurator: function(configuration) {
          configuration.defaultTimezone('{{site_timezone}}');
        }
      });

      hellobar('base.styling', {
        configurator: function(configuration) {
          configuration.externalCSS({{{hellobar_container_css}}});
        }
      });

      hellobar('base.templating', {
        configurator: function(configuration) {
          {{#templates}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/templates}}

          {{#branding_templates}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/branding_templates}}

          {{#content_upgrade_template}}
            configuration.addTemplate("{{name}}", {{{markup}}});
          {{/content_upgrade_template}}
        }
      });

      hellobar('geolocation', {
        configurator: function(configuration) {
          configuration.geolocationUrl('{{geolocation_url}}');
        }
      });

      !isPreviewMode() && hasCapability('geolocation_injection') && hellobar('geolocation.injection', {
        configurator: function(configuration) {
          configuration.autoRun(true);
        }
      });

      hellobar('elements', {
        configurator: function(configuration) {
          configuration.elementCSS({{{hellobar_element_css}}});
        }
      });

      hellobar('elements.rules', {
        configurator: function(configuration) {
          {{#rules}}
            configuration.addRule('{{match}}', {{{conditions}}}, {{{site_elements}}});
          {{/rules}}
        }
      });

      hellobar('tracking.internal', {
        configurator: function(configuration) {
          configuration.backendHost('{{hb_backend_host}}').siteWriteKey('{{site_write_key}}');
        }
      });

      hellobar('contentUpgrades', {
        configurator: function(configuration) {
          configuration.contentUpgrades({{{content_upgrades_json}}}).styles({{{content_upgrades_styles_json}}});
        }
      });

      !isPreviewMode() && hasCapability('autofills') && hellobar('autofills', {
        configurator: function(configuration) {
          var autofills = {{{autofills_json}}};
          configuration.autofills(autofills).autoRun(true);
        }
      });
    })();

    {{{libs_js}}}

    (function() {

      HBInit = function () {
        if (Object.prototype.toString.call( _hbq ) === "[object Array]") {
          HB.CAP = {{{capabilities_json}}};
          // Protect capabilities from being modified
          if ( typeof(Object.defineProperty) != "undefined")
          {
            try{Object.defineProperty(HB, 'CAP', {writable:false, configurable: false});}catch(e){};
            for(var p in HB.CAP)
            {
              try{Object.defineProperty(HB.CAP, p, {writable:false, configurable: false})}catch(e){};
            }
          }




        }
      }

      HBInit();



      if(!HB.isIEXOrLess(8) && {{script_is_installed_properly}}) {
        _hbq = new HBQ();
      }
    })();
  }
})();
